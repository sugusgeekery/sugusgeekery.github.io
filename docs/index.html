<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>摄像头拍照</title>
  <style type="text/css">
  	html, body {
  		margin: 0;
  		padding: 0;
  		background: #FFFFFF;
  		color: #B1B1B1;
  		font-size: 16px;
  	}
  </style>
</head>
<body>
  <video id="video" 
	controls 
	controlslist="nodownload" 
	disablePictureInPicture 
	x5-video-player-type='h5'
	x5-video-player-fullscreen='true' 
	playsinline 
	webkit-playsinline 
	x-webkit-airplay="allow" 
	x5-video-orientation="portraint"
	poster=""
	style="position:relative;top:0;left:0;width: 100%;object-fit: cover;"
	>
	  <!-- <source src="https://www.flexclip.com/media/pages/video/home-banner-video.mp4" type="video/mp4"></source> -->
	  <!-- <source src="myvideo.ogv" type="video/ogg"></source>
	  <source src="myvideo.webm" type="video/webm"></source>
	  <object width="" height="" type="application/x-shockwave-flash" data="myvideo.swf">
		<param name="movie" value="myvideo.swf" />
		<param name="flashvars" value="autostart=true&amp;file=myvideo.swf" />
	  </object>
	  当前浏览器不支持 video直接播放，点击这里下载视频： <a href="myvideo.webm">下载视频</a> -->
  </video>
  <input type="file" name="" id="file" onchange="getFile(this)"/>
  <div>
    <button id="capture">拍照</button>
  </div>
  <canvas id="canvas"></canvas>
  <div style="width: 100%; overflow: auto;">
	  <img id="img" anonymous alt="222" style="width: 100%;">
  </div>
  <script src="https://unpkg.com/vue@next"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
	
    //访问用户媒体设备的兼容方法
    function getUserMedia(constraints, success, error) {
      if (navigator.mediaDevices.getUserMedia) {
        //最新的标准API
        navigator.mediaDevices.getUserMedia(constraints).then(success).catch(error);
      } else if (navigator.webkitGetUserMedia) {
        //webkit核心浏览器
        navigator.webkitGetUserMedia(constraints,success, error)
      } else if (navigator.mozGetUserMedia) {
        //firfox浏览器
        navigator.mozGetUserMedia(constraints, success, error);
      } else if (navigator.getUserMedia) {
        //旧版API
        navigator.getUserMedia(constraints, success, error);
      }
    }
	
	function getQueryVariable(variable) {
	   var query = window.location.search.substring(1);
	   var vars = query.split("&");
	   for (var i=0;i<vars.length;i++) {
			var pair = vars[i].split("=");
			if(pair[0] == variable){
			   return pair[1];
			}
	   }
	   return(false);
	}
	
	function _url2xml2file(url, exportImageType = 0) {
	    url =
	      url + (/\?/.test(url) ? "&" : "?") + "timestamp=" + new Date().getTime();
	    return new Promise((resolve, reject) => {
	      const xhr = new XMLHttpRequest();
	      if (!xhr) {
	        throw new Error("CORS not supported");
	      }
	      xhr.open("get", url);
	      xhr.responseType = "blob";
	      xhr.onload = function() {
	        if (this.status == 200) {
	          if (exportImageType == 1) {
	            // 导出base64格式
	            const reader = new FileReader();
	            reader.readAsDataURL(this.response);
	            reader.onload = function() {
	              resolve(this.result);
	            };
	          } else {
	            // 默认导出blobURL格式
	            resolve(URL.createObjectURL(this.response));
	          }
	        } else {
	          reject();
	        }
	      };
	      // xhr.onloadstart	= function (e) {
	      //     console.log('开始', e)
	      // }
	      // xhr.onprogress = function (e) {
	      //     console.log('请求中', e)
	      // }
	      // xhr.onabort	= function (e) {
	      //     console.log('打断', e)
	      // }
	      xhr.onerror = function(e) {
	        // console.log('错误', e)
	        reject(e);
	      };
	      xhr.ontimeout = function(e) {
	        // console.log('超时', e)
	        reject(e);
	      };
	      // xhr.onloadend = function (e) {
	      //     console.log('加载完成', e)
	      // }
	      xhr.send();
	    });
	  }

	
	let width = window.innerWidth;
	let height = window.innerHeight;
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
	let img = document.getElementById('img');
    let context = canvas.getContext('2d');
	let userId = "121";
	img.width = width;
	video.width = width;
	canvas.width = width;
	img.height = height;
	video.height = height * (1 - 0.5);
	canvas.height = height;
	
	let file = null;
	function getFile(e) {
		file = document.getElementById("file").files[0]
		console.log(file)
	}
	
	function download(href = "", filename = "") {
	  if (href) {
	    const a = document.createElement("a");
	    a.download = filename;
	    a.href = href;
	    document.body.appendChild(a);
	    a.click();
	    a.remove();
	  }
	}

    function success(stream) {
      //兼容webkit核心浏览器
      let CompatibleURL = window.URL || window.webkitURL;
      //将视频流设置为video元素的源
      console.log(stream);

      //video.src = CompatibleURL.createObjectURL(stream);
      video.srcObject = stream;
      video.play();
    }

    function error(error) {
      console.log(`访问用户媒体设备失败${error.name}, ${error.message}`);
    }

    

    document.getElementById('capture').addEventListener('click', function () {
		console.log(width, height,video.width, video.height, video.videoWidth, video.videoHeight)
		context.drawImage(video, 0, 0, video.width, video.width / video.videoWidth * video.videoHeight);
		
		// base64
		var base64 = canvas.toDataURL("image/jpeg", 1.0);
		img.src = base64;
		sendData(base64);
		download(base64);
		
		// Blob
		// canvas.toBlob(function(blob) {
		// 	const url = window.URL.createObjectURL(blob)
		// 	alert('bloburl=' + url);
		// 	alert('blob=' + blob.toString());
		// 	img.src = url;
		// 	// window.URL.revokeObjectURL(url)
		// 	download(url, +new Date());
		// 	sendData(blob);
		// }, "image/png");
		
    })
	
	function sendData(img) {
		// let url = 'http://developsys.hotpick.com/sys/oauth/loginByFace';
		let url = 'http://192.168.0.22:8090/sys/oauth/loginByFace';
		// let url = 'http://developsys.hotpick.com/sys/common/uploadForm';
		alert('userId=' + userId);
		alert('url=' + url);
		
		
		// json
		// axios.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded';
		// let data = {
		// 	img: img,
		// 	userId: userId
		// };
		
		// form
		axios.defaults.headers.post['Content-Type'] = 'multipart/form-data';
		let data = new FormData()
		// data.append("files", file);
		data.append("img", file);
		alert('img=' + img.toString());
		data.append("userId", userId);
		alert('data=' + data.toString());
		
		axios.post(url, data)
		.then(function (response) {
			alert('response=' + response.toString());
			console.log(response);
		})
		.catch(function (error) {
			alert('error=' + error.toString());
			console.log(error);
		});
	}
	
	window.onload = function() {
		if (navigator.mediaDevices.getUserMedia || navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia) {
		  //调用用户媒体设备, 访问摄像头
		  getUserMedia({video : {width: width, height: height}}, success, error);
		} else {
		  alert('不支持访问用户媒体');
		}
		userId = getQueryVariable("userId");
		// _url2xml2file("https://www.flexclip.com/media/pages/video/home-banner-video.mp4").then(res => {
		// 	video.src = res;
		// })
		// video.src = "./home-banner-video.mp4";
		// video.src = "https://www.flexclip.com/media/pages/video/home-banner-video.mp4";
		// video.onload = function(e) {
		// 	console.log(e)
		// 	video.play();
		// }
		
	}
  </script>
</body>
</html>